generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  name      String
  type      String    // 'CLIENT' ou 'ENGINEER'
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relacionamentos
  obras     Obra[]    @relation("EngenheiroObras")
  mensagens Mensagem[] @relation("UsuarioMensagens")
  rdos      RDO[]     @relation("UsuarioRDOs")

  @@index([email])
}

model Obra {
  id           Int       @id @default(autoincrement())
  name         String
  clientName   String
  address      String?
  progress     Int       @default(0)
  status       String    @default("em_andamento") // em_andamento, pausada, concluída
  startDate    String?
  estimatedEnd String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relacionamento com Engenheiro
  engineerId   Int
  engineer     User      @relation("EngenheiroObras", fields: [engineerId], references: [id], onDelete: Cascade)

  // Relacionamentos com outras entidades
  etapas       Etapa[]   @relation("ObraEtapas")
  fotos        Foto[]    @relation("ObraFotos")
  mensagens    Mensagem[] @relation("ObraMensagens")
  rdos         RDO[]     @relation("ObraRDOs")

  @@index([engineerId])
}

model Etapa {
  id           Int       @id @default(autoincrement())
  phase        String    // Ex: "S1: Mobilização", "S2: Demolição"
  description  String
  status       String    @default("pendente") // pendente, em_andamento, concluída
  progress     Int       @default(0)
  startDate    String?
  endDate      String?
  budget       Float?    // Orçado para esta etapa
  spent        Float?    // Gasto até agora
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relacionamento com Obra
  obraId       Int
  obra         Obra      @relation("ObraEtapas", fields: [obraId], references: [id], onDelete: Cascade)

  @@index([obraId])
}

model Foto {
  id        Int       @id @default(autoincrement())
  url       String
  caption   String?
  date      String
  category  String    @default("geral") // geral, progresso, problema, cliente
  createdAt DateTime  @default(now())

  // Relacionamento com Obra
  obraId    Int
  obra      Obra      @relation("ObraFotos", fields: [obraId], references: [id], onDelete: Cascade)

  @@index([obraId])
}

model Mensagem {
  id        Int       @id @default(autoincrement())
  content   String
  createdAt DateTime  @default(now())

  // Relacionamentos
  obraId    Int
  obra      Obra      @relation("ObraMensagens", fields: [obraId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User      @relation("UsuarioMensagens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([obraId])
  @@index([userId])
}

model RDO {
  id           Int       @id @default(autoincrement())
  date         String    // Data do RDO (formato: DD/MM/YYYY)
  content      String    // Conteúdo do relatório
  status       String    @default("rascunho") // rascunho, enviado, aprovado
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relacionamentos
  obraId       Int
  obra         Obra      @relation("ObraRDOs", fields: [obraId], references: [id], onDelete: Cascade)
  
  userId       Int
  user         User      @relation("UsuarioRDOs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([obraId])
  @@index([userId])
}